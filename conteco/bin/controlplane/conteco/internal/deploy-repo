#!/usr/bin/env bash
deployPath=$1

(
	defaultPath="${CONTECO_PWD}/${CONTECO_REALM}/modeco.base.base"
	if [[ ! -d $defaultPath ]] ; then
		echo "Base Module Template Not Available!: $defaultPath"
		exit 1
	fi
	executionplane-info "DEFAULT     REPO: $defaultPath"
	rootPath=$1
	executionplane-info "SOURCE      REPO: $rootPath"
	export MODECO_NAME="${CONTECO_TYPE}_${CONTECO_NAME}"
	modecoPath="${CONTECO_PWD}/${CONTECO_REALM}/modeco.base.${MODECO_NAME}"
	executionplane-info "DESTINATION REPO: $modecoPath"

	if [[ ! -d $modecoPath ]] ; then
		mkdir $modecoPath
		executionplane-info "Repository root $modecoPath created."
		cp -rf $defaultPath/* $modecoPath
		executionplane-info "Copied default repository assets to $modecoPath."
		(cat $defaultPath/environment | envsubst) > $modecoPath/environment
		executionplane-info "Created module environment"
		(
			current=$(pwd)
			cd $modecoPath
			executionplane git init
			cd $current
		)
		executionplane-info "Initialised repository."
	else
		executionplane-info "Repository already exists at $modecoPath."
	fi

	# copy stack docker-compose.yml files
	mkdir -p $modecoPath/modeco/stacks
	for f in $rootPath/conteco/docker-compose/stacks/*;
	do
		filename=$(basename $f)
		cat $f | envsubst '$CONTECO_REALM,$CONTECO_ECOSYSTEM' > $modecoPath/modeco/stacks/${filename}
		executionplane-info "Copied $filename to ${filename}"
		done;

	# create / update settings.base
	cp $rootPath/conteco/docker-compose/environment.module $modecoPath/modeco/settings.base
	executionplane-info "Copied environment.modeco to settings.base"
	if [[ ! -d $modecoPath/modeco/settings ]] ; then
		cp $rootPath/conteco/docker-compose/environment.module $modecoPath/modeco/settings
		executionplane-info "Created initial settings"
	fi
)
