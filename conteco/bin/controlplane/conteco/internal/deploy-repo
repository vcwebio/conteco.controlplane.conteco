#!/usr/bin/env bash
deployPath=$1

(
	defaultPath="${CONTECO_PWD}/${CONTECO_REALM}/conteco.controlplane.conteco/conteco/assets/modeco"
	executionplane-info "DEFAULT     REPO: $defaultPath"
	rootPath=$1
	executionplane-info "SOURCE      REPO: $rootPath"
	if [[ " stack module " == *"$CONTECO_TYPE"* ]] ; then
		export MODECO_TYPE="${CONTECO_NAME}"
	else
		export MODECO_TYPE="${CONTECO_TYPE}_${CONTECO_NAME}"
	fi
	modecoPath="${CONTECO_PWD}/${CONTECO_REALM}/modeco.${MODECO_TYPE}.base"
	executionplane-info "DESTINATION REPO: $modecoPath"
	
	if [[ ! -d $modecoPath ]] ; then
		mkdir $modecoPath
		executionplane-info "Repository root $modecoPath created."
		cp -rf $defaultPath/* $modecoPath
		executionplane-info "Copied default repository assets to $modecoPath."
		(cat $defaultPath/environment | envsubst) > $modecoPath/environment
		executionplane-info "Created module environment"
		(
			current=$(pwd)
			cd $modecoPath
			executionplane git init
			cd $current
		)
		executionplane-info "Initialised repository."
	else
		executionplane-info "Repository already exists at $modecoPath."
		# update How To help section
		for f in $defaultPath/docs/HOW-TO*
		do
			cat $f | envsubst > $modecoPath/docs/$(basename $f)
			done;
		executionplane-info "Update How To help section."
	fi

	# copy stack docker-compose.yml files
	mkdir -p $modecoPath/modeco/stacks
	if [[ -f $rootPath/conteco/docker-compose/docker-compose.yml ]] ; then
		cat $rootPath/conteco/docker-compose/docker-compose.yml | envsubst '$CONTECO_REGISTRY,$CONTECO_REALM,$CONTECO_ECOSYSTEM' \
			> $modecoPath/modeco/stacks/${CONTECO_TYPE}.${CONTECO_NAME}.docker-compose.yml.template
		executionplane-info "Copied docker-compose.yml to ${CONTECO_TYPE}.${CONTECO_NAME}.docker-compose.yml.template"
	else
		for f in $rootPath/conteco/docker-compose/*.docker-compose.yml;
		do
			filename=$(basename $f)
			cat $f | envsubst '$CONTECO_REGISTRY,$CONTECO_REALM,$CONTECO_ECOSYSTEM' > $modecoPath/modeco/stacks/${filename}.template
			executionplane-info "Copied $filename to ${filename}.template"
			done;
	fi

	# create / update settings.template
	cp $rootPath/conteco/docker-compose/environment.module $modecoPath/modeco/settings.template
	executionplane-info "Copied environment.module to settings.template"
)
