#!/usr/bin/env bash
deployPath=$1

# generate environment file
environment_file=$'#!/usr/bin/env bash\n\n'
environmentEntry=$(sed -n "/# START CONFIGURATION/,/# END CONFIGURATION/p" $deployPath/environment)
environment_file="${environment_file}${environmentEntry}

"
environmentEntry=$(sed -n "/# START GLOBAL SETTINGS/,/# END GLOBAL SETTINGS/p" $deployPath/environment)
environment_file="${environment_file}${environmentEntry}
"

tmpfile=$(mktemp /tmp/environmentfile.XXXXXX)
cat $deployPath/environment.template > $tmpfile

sed -i '/#!\/usr\/bin\/env bash/d' $tmpfile
IFS=',' read -r -a keys <<< "${CONTECO_DC_GLOBAL}"
for key in ${keys[@]};
do
	sed -i "/${key:1}/d" $tmpfile
	done;
environment_file="${environment_file}$(cat $tmpfile)

"

#environmentEntry=$(sed -n "/# START TOPLEVEL SETTINGS/,/# END TOPLEVEL SETTINGS/p" $deployPath/environment)
#environment_file="${environment_file}${environmentEntry}
#"

intermediate=$(grep _VOLUMES_ $tmpfile | grep -v _GLOBAL | cut -d'"' -f 2 | tr '\n' '|')
intermediate="${intermediate//|/: \{ \}, }"
intermediate=$(echo $intermediate | sed 's/.$//')
environment_file="${environment_file}# START TOPLEVEL SETTINGS
export CONTECO_DC_GLOBAL_VOLUMES=\"$intermediate\"
export CONTECO_DC_GLOBAL_NETWORKS=\"${CONTECO_ECOSYSTEM}_overlay: { external: true }\"
# END TOPLEVEL SETTINGS
"
rm $tmpfile
echo "$environment_file" > $deployPath/environment
		