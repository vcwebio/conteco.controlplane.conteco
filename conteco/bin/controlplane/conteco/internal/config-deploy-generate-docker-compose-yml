#!/usr/bin/env bash
deployPath=$1
if [[ "$CONTECO_TYPE" == "module" ]] ; then
	IFS=',' read -r -a stacks <<< "${CONTECO_DC_GLOBAL_STACKS}"
	for stackNumber in ${!stacks[@]};
	do
		stack=${stacks[stackNumber]}
		destination="$deployPath/$stack.docker-compose.yml"
		source="$destination.template"
		cat $source | envsubst "$CONTECO_DC_GLOBAL" > $destination
		done;
else
	export CONTECO_TYPE_DOT_NAME="${CONTECO_TYPE}.${CONTECO_NAME}"
	templatePath="$deployPath/stacks/docker-compose.yml.template"
	if [ ! -f "$templatePath" ]; then
		templatePath="/conteco/docker-compose/stacks/docker-compose.yml.template"
	fi
	token=$(echo "$CONTECO_DC_GLOBAL_STACKNAMES" | tr - _)
	tmpfile=$(mktemp /tmp/docker-compose.yml.template.XXXXXX)
	destination=$deployPath/stacks/${token}.docker-compose.yml
	cat $templatePath | envsubst '$CONTECO_TYPE_DOT_NAME'	> $tmpfile
	sed -i -e "s/CONTECO_DC_SERVICE_/CONTECO_DC_${token^^}_/g" $tmpfile
	cat $tmpfile | envsubst "$CONTECO_DC_GLOBAL"	> $destination
	rm $tmpfile
fi
