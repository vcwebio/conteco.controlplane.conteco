#!/usr/bin/env bash
deployPath=$1

(
DOLLAR="$"
environment_template=$'#!/usr/bin/env bash\n\n'
IFS=',' read -r -a stacks <<< "${CONTECO_DC_GLOBAL_STACKS}"
IFS=',' read -r -a stackNames <<< "${CONTECO_DC_GLOBAL_STACKNAMES}"
IFS=',' read -r -a stackNamesPrevious <<< "${CONTECO_DC_GLOBAL_STACKNAMES_PREVIOUS}"
for stackNumber in ${!stacks[@]};
do
	stack=${stacks[stackNumber]}
	stackName=${stackNames[stackNumber]}
	stackNamePrevious=${stackNamesPrevious[stackNumber]}
	stackPath="${CONTECO_PWD}/${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.$stack/conteco/docker-compose"
	source="$stackPath/stacks/$stackNamePrevious.docker-compose.yml"
	destination="$deployPath/stacks/$stackName.docker-compose.yml.template"
	cp $source $destination
	sed -i -e "s/CONTECO_DC_${stackNamePrevious^^}_/CONTECO_DC_${stackName^^}_/g" $destination
#	sed -i -e "s/CONTECO_DC_${stackName}_GLOBAL/CONTECO_DC_GLOBAL/g" $destination
	stackEnvironment=$(sed -n "/# START SETTINGS/,/# END SETTINGS/p" $stackPath/environment)
	stackEnvironment=${stackEnvironment//CONTECO_DC_${stackNamePrevious^^}_/CONTECO_DC_${stackName^^}_}
	environment_template="${environment_template}${stackEnvironment}
"
	done;
echo "$environment_template" > $deployPath/environment.template
)
