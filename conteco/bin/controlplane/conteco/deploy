#!/usr/bin/env bash
if [[ "$1" == "for-each-node" ]] ; then
(
	shift
    . executionplane-invoke "$0 $@"
	imageName="${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.${CONTECO_TYPE}.${CONTECO_NAME}"
	if [[ $# -gt 1 ]] ; then
		command=$1
		shift
	else
		command="up"
	fi
	if [[ $# -gt 1 ]] ; then
		dockercompose=$1
		stackNumber=$2
		rootPath="${CONTECO_PWD}/${BASH_ARGV[0]}"
	else
		rootPath="${CONTECO_PWD}/$1"
	fi
	deployPath="$rootPath/conteco/docker-compose"
	. $deployPath/environment
	if [[ "$dockercompose" == *"docker-compose.yml" ]] ; then
		dockercompose="$deployPath/$dockercompose"
	else
		dockercompose="$deployPath/docker-compose.yml"
	fi
	if [[ "$CONTECO_TYPE" == "module" ]] ; then
		stackName="${CONTECO_TYPE}_${CONTECO_NAME}_$stackNumber"
	else 
		stackName="${CONTECO_TYPE}_${CONTECO_NAME}"
	fi
	case $command in
		repo)
			deploy-repo $rootPath
			;;
		*)
			if [[ -f $dockercompose ]] ; then

				if [[ "$command" == "down" ]] ; then
					executionplane docker stack remove  "$stackName"
				elif [[ "$command" == "downup" ]] ; then
					executionplane docker stack remove  "$stackName"
					deploy-up $stackName $dockercompose
				elif [[ "$command" == "up" ]] ; then
					deploy-up $stackName $dockercompose
				fi

			else

				moduleStacks="${CONTECO_DC_GLOBAL_STACKS}"
				IFS=',' read -r -a stacks <<< "$moduleStacks"
				for stackNumber in ${!stacks[@]};
				do
					stack=${stacks[stackNumber]}
					deploy $command "$stackNumber.$stack.docker-compose.yml" $stackNumber $@
					done;

			fi
			;;
	esac
	executionplane-complete
)
else
    export PATH="$CONTECO_EXECUTIONPLANE_APIINTERNALPATH_CONTECO"
	for-each $(basename $0) $@
fi
