#!/usr/bin/env bash
(
	export PATH="$CONTECO_EXECUTIONPLANE_APIINTERNALPATH_CONTECO"
	. executionplane-invoke "$0 $@"
	imageName="${@: -1}"
	rootPath="/conteco/pwd/${imageName}"
	. $rootPath/environment

	export CONTECO_STACKPREFIX="conteco_dc"
	export CONTECO_NETWORKLOCAL="conteco_dc"
	export CONTECO_NETWORKGLOBAL="conteco_dc"

	case $1 in
		--info)
			.base deploy $@
		;;
		*)
			if [[ $# -gt 1 ]] ; then
				command=$1
			else
				command="up"
			fi
			if [[ $# -gt 2 ]] ; then
				dockercompose=$2
				stackName=$3
			fi
			deployPath="$rootPath/conteco/docker-compose"
			. $deployPath/environment
			if [[ "$dockercompose" == *"docker-compose.yml" ]] ; then
				dockercompose="$deployPath/stacks/$dockercompose"
			fi
			if [[ "$CONTECO_TYPE" == "module" ]] ; then
				stackName="${CONTECO_NAME}_conteco_dc_$stackName"
			else
				stackName="${CONTECO_DC_GLOBAL_STACKNAMES}"
			fi
			if [[ -f $dockercompose ]] ; then
				if [[ "$command" == "down"* ]] ; then
					executionplane docker stack remove  "$stackName"
					sleep 1
					executionplane docker network rm  "${CONTECO_NETWORKLOCAL}_overlay"
					sleep 1
					executionplane docker container prune --force
					sleep 1
					executionplane docker volume rm $(echo "$CONTECO_DC_GLOBAL_VOLUME_LIST" | envsubst)
				fi
				if [[ "$command" == *"up" ]] ; then
					executionplane docker volume rm $(echo "$CONTECO_DC_GLOBAL_VOLUME_LIST" | envsubst)
					executionplane docker network create -d overlay  "${CONTECO_NETWORKLOCAL}_overlay"
					executionplane docker volume create $(echo "$CONTECO_DC_GLOBAL_VOLUME_LIST" | envsubst)
					deploy-up $stackName $dockercompose
				fi
			else
				IFS=',' read -r -a stackNames <<< "${CONTECO_DC_GLOBAL_STACKNAMES}"
				for stackName in ${stackNames[@]};
				do
					deploy $command "$stackName.docker-compose.yml" $stackName $@
					done;
			fi
		;;
	esac
	executionplane-complete
)
