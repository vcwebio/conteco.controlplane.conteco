#!/usr/bin/env bash
if [[ "$1" == "for-each-node" ]] ; then
(
	shift
    . executionplane-invoke "$0 $@"
	imageName="${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.${CONTECO_TYPE}.${CONTECO_NAME}"
	if [[ $# -gt 1 ]] ; then
		command=$1
		shift
	else
		command="up"
	fi
	if [[ $# -gt 1 ]] ; then
		dockercompose=$1
		rootPath="${CONTECO_PWD}/${BASH_ARGV[0]}"
	else
		rootPath="${CONTECO_PWD}/$1"
	fi
	deployPath="$rootPath/conteco/docker-compose"
	. $deployPath/environment
	if [[ "$dockercompose" == *"docker-compose.yml" ]] ; then
		dockercompose="$deployPath/$dockercompose"
	else
		dockercompose="$deployPath/docker-compose.yml"
	fi

	if [[ -f $dockercompose ]] ; then

		if [[ "$command" == "down" ]] ; then
			executionplane docker stack remove  "${CONTECO_TYPE}_${CONTECO_NAME}"
		elif [[ "$command" == "downup" ]] ; then
			executionplane docker stack remove  "${CONTECO_TYPE}_${CONTECO_NAME}"
			deploy-up $rootPath $dockercompose
		elif [[ "$command" == "up" ]] ; then
			deploy-up $rootPath $dockercompose
		fi

	else

		moduleStacks="${CONTECO_DC_GLOBAL_STACKS}"
		IFS=',' read -r -a stacks <<< "$moduleStacks"
		for stack in ${stacks[@]};
		do
			deploy $command "$stack.docker-compose.yml" $@
			done;

 	fi
	executionplane-complete
)
else
    export PATH="$CONTECO_EXECUTIONPLANE_APIINTERNALPATH_CONTECO"
	for-each $(basename $0) $@
fi
